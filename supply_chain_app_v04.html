

<!DOCTYPE html>
<html lang="ja" >

<head>

  <meta charset="UTF-8">

  <title>サプライチェーン解析</title>
  
  
  
  
<style>
html,
body,

#mainDiv {
  width:100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background-color: black;
  color: white;
}

#select_storyId {
  border-radius: 5px;
  padding: 10;
}

#headerDiv {
  display: flex;
  justify-content: space-evenly;
  flex-direction: row;
  padding: 5px;
}

.change_body {
  margin: 0 0 0 auto;
  position: relative;
  display: inline-block;
  padding: 0.25em 0.5em;
  text-decoration: none;
  color: #FFF;
  background: #fd9535;
  border-bottom: solid 2px #d27d00;
  border-radius: 4px;
  box-shadow: inset 0 2px 0 rgba(255,255,255,0.2), 0 2px 2px rgba(0, 0, 0, 0.19);
  font-weight: bold;
  width: 120px;
  cursor: pointer;
}

.change_body:active {
  border-bottom: solid 2px #fd9535;
  box-shadow: 0 0 2px rgba(0, 0, 0, 0.30);
}

#timeslider_centermainDiv {
  height: 90%;
  width: 100%;
  display: flex;
  flex-direction: row;
}

#timeslider_leftDiv {
  width: 30%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

#timeslider_mapviewDiv {
  padding: 0;
  margin: 0;
  height: 100%;
  width: 40%;
  background-color: black;
}

#timeslider_rightDiv {
  padding: 0;
  height: 100%;
  width: 30%;
}

#timeslider_InundationDepthDiv {
  height: 40%;
  width: 100%;
  display: flex;
  flex-direction: column;
}

.inundation-depth-panel {
  display: flex;
  flex-direction: row;
}

.inundation-depth-image {
  height: 30px;
  width: auto;
  padding: 5px;
}

#timeslider_SuspendedSupplyChainDiv {
  height: 60%;
  width: 100%;
  display: flex;
  flex-direction: column;
}

#timeslider_footerDiv {
  padding: 0;
  height: 10%;
  width: 100%;
  display: flex;
  flex-direction: row;
}

.chartStyle {
  display: -webkit-box;
  display: block;
  flex-wrap: wrap; 
  -webkit-box-orient: vertical; 
  --flex-direction: column;
  height: 100%;
  width: 100%;
  align-content: left;
  padding: 0px;
  overflow-y: hidden;
  overflow-x: hidden;
}

#timeSliderValue {
  min-height: 10%;
  color: chocolate;
  font-size: 24px;
  display: flex;
  align-items: center;
  -webkit-justify-content: center;
  min-width: 10%;
  margin-bottom: 10px;
}

#timeSliderDiv {
  height: auto;
  width: 90%;
  margin-bottom: 10px;
}

/* esri overrides */
.esri-time-slider__layout--wide .esri-time-slider__time-extent,
.esri-time-slider__layout--compact .esri-time-slider__time-extent,
.esri-time-slider__layout--wide .esri-time-slider__min,
.esri-time-slider__layout--wide .esri-time-slider__max,
.esri-time-slider__layout--compact .esri-time-slider__min-date,
.esri-time-slider__layout--compact .esri-time-slider__max-date,
.esri-legend__layer-caption {
  display: none !important;
}

.body-active {
  display: flex;
  width: 100%;
  height: 90%;
  flex-direction: column;
}

.body-nonactive {
  display: none;
}

.header_icon {
  width: 40px;
  height: 40px;
}

.title {
  font-size: 24px;
  color: white;
  font-weight: bold;
  padding-left: 10px;
}

.subtitle {
  font-size: 16px;
  color: red;
  font-weight: bold;
  padding-left: 10px;
}

.menutitle {
  display: flex;
  align-items: center;
  font-size: 16px;
  color: white;
  font-weight: bold;
  padding-left: 100px;
  height: 100%;
}

ul {
  margin-top: 0px;
  padding-top: 0px;
  padding-bottom: 0px;
  padding-left: 10px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

ul + div {
  display: none;
}

ul:empty + div {
  margin-top: 0px;
  padding-top: 0px;
  padding-left: 10px;
  display: block;
  font-size: 14px;
}

li {
  list-style: none;
  width: 90%;
  background-color: rgba(0, 0, 0, 0.05);
  padding: 10px 10px 10px 10px;
  border: 1px solid #CCC;
  box-shadow: inset 1px 1px 0 rgba(255, 255, 255, 0.5);
  margin-bottom: 5px;
  box-sizing: border-box;
  cursor: pointer;
  border-radius: 3px;
  font-size: 9px;
}

.li_selected {
  background-color: rgba(0, 0, 120, 0.8);
}

li:hover {
  background-color: rgba(0, 0, 120, 0.5);
}

#alltime_centermainDiv {
  height: 100%;
  width: 100%;
  display: flex;
  flex-direction: row;
}

#alltime_mapviewDiv {
  padding: 0;
  margin: 0;
  height: 100%;
  width: 50%;
  background-color: black;
}

#alltime_rightDiv {
  padding: 0;
  height: 100%;
  width: 50%;
  display: block;
}

alltime_InundationDepth {
  padding: 0;
  height: 40%;
  width: 100%; 
}

#inundationDepthChartCanvas {
  height: 100%;
  max-height: 300px;
}

#alltime_transitionDiv {
  padding: 0;
  height: 60%;
  width: 100%;
}

.tab-group{
  display: flex;
  justify-content: center;
  height: auto;
}

.tab{
  flex-grow: 1;
  height: 20px;
  padding:0px;
  list-style:none;
  /*border:solid 1px #CCC;*/
  text-align:center;
  cursor:pointer;
}

.tab.is-active{
  background:#F00;
  color:#FFF;
  transition: all 0.2s ease-out;
}

.panel-group{
  height:100%;
}
.panel{
  display:none;
}
.panel.is-show{
  display:block;
}
</style>

  
  
  
  

</head>

<body translate="no" >
  <html>
  <head>
    <meta charset="utf-8" />
    <meta
          name="viewport"
          content="initial-scale=1,maximum-scale=1,user-scalable=no"
          />
    <title>
      サプライチェーンリスク解析
    </title>

    <link
          rel="stylesheet"
          href="https://js.arcgis.com/4.20/esri/themes/dark-red/main.css"
          />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script src="https://js.arcgis.com/4.20/"></script>
  </head>

  <body>
    <div id="mainDiv">
      <div id="headerDiv">
        <img class="header_icon" src="https://ej-nagoya.maps.arcgis.com/sharing/rest/content/items/5502f07c4aff40c2b19fd971b5878946/data">
        <span class="title">Supply Chain Flood Risk Simulation</span>
        <span class="menutitle">Choise Story：</span>
        <select id="select_storyId">
        </select>
        <button id="change_body" class="change_body">All Time</button>
      </div>
      <div id="body1Div" class="body-active">
        <div id="timeslider_centermainDiv">
          <div id="timeslider_leftDiv">
            <span class="subtitle">Operation Supply Chain</span>
            <div id="classificationChartDiv" class="chartStyle">
              <canvas id="classificationChartCanvas"/>
            </div>
            <div>
              <input type="checkbox" id="check_rate" name="check_rate">
              <label for="check_rate">Display Rate</label>
            </div>
          </div>
          <div id="timeslider_mapviewDiv"></div>
          <!--
          <div id="timeslider_rightDiv">
            <span class="subtitle">Suspended Supply Chain</span>
            <ul id="supply-chain-list">
            </ul>
            <div>No Data</div>
          </div>
          -->
          <div id="timeslider_rightDiv">
            <div id="timeslider_InundationDepthDiv">
              <span class="subtitle">Observatory inundation depth</span>
              <ul id="inundation-depth-list">
              </ul>
              <div>No Data</div>
            </div>
            <div id="timeslider_SuspendedSupplyChainDiv">
              <span class="subtitle">Suspended Supply Chain</span>
              <ul id="supply-chain-list">
              </ul>
              <div>No Data</div>
            </div>
          </div>
        </div>
        <div id="timeslider_footerDiv">
          <div id="timeSliderValue">4/1</div>
          <div id="timeSliderDiv"></div>
        </div>
      </div>
      <div id="body2Div" class="body-nonactive">
        <div id="alltime_centermainDiv">
          <div id="alltime_mapviewDiv"></div>
          <div id="alltime_rightDiv">
            <div id="alltime_InundationDepth">
              <span class="subtitle">Inundation Depth Time Transition</span>
              <canvas id="inundationDepthChartCanvas"/>
            </div>
            <div id="alltime_transitionDiv">
              <span class="subtitle">Supply Chain Time Transition</span>
              <ul id=timeSeriesChartTab class="tab-group">
              </ul>
              <div id="timeSeriesChartDiv" class="chartStyle">
                <div id="timeSeriesChartPanel">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="timeslider_FloodDiv" class="esri-component esri-widget">
        <div class="esri-widget--button esri-widget esri-interactive switchImage" 
             style="width: 150px">
          <span class="esri-icon esri-icon-layers imagelayertype">Flood(Risk)</span> 
        </div>
      </div>
      <div id="timeslider_TypeDiv" class="esri-component esri-widget">
        <div class="esri-widget--button esri-widget esri-interactive switchType" style="width: 150px">
          <span class="esri-icon esri-icon-layers changetype">Summary</span>
        </div>
      </div>
      <div id="alltime_FloodDiv" class="esri-component esri-widget">
        <div class="esri-widget--button esri-widget esri-interactive switchImage" 
             style="width: 150px">
          <span class="esri-icon esri-icon-layers imagelayertype">Flood(Risk)</span> 
        </div>
      </div>
    </div>
  </body>
</html>
  
  
      <script id="rendered-js" >
require([
  "esri/WebMap", 
  "esri/layers/FeatureLayer",
  "esri/layers/TileLayer",
  "esri/views/MapView",
  "esri/widgets/Legend",
  "esri/widgets/Expand",
  "esri/widgets/TimeSlider",
  "esri/layers/ImageryLayer",
  "esri/layers/GraphicsLayer",
  "esri/Graphic",
  "esri/tasks/support/Query",
  "esri/layers/support/MosaicRule"
], function (
        WebMap,
         FeatureLayer,
         TileLayer,
         MapView,
         Legend,
         Expand,
         TimeSlider,
         ImageryLayer,
         GraphicsLayer,
         Graphic,
         Query,
         MosaicRule
        ) {

  cnt = 0;

  var supplyFeturelayer = null;
  var supply_availableFeturelayer = null;
  var timeslider_obeservatory_Feturelayer = null;
  var timeslider_hazard_shinsuiImagelayer = null;
  var timeslider_risk_shinsuiImagelayer = null;
  var summary_notavailableGraphicsLayer = null;
  var obeservatoryInudationDepthTable = null;

  var alltime_obeservatoryFeturelayer = null;
  var alltime_supplyFeturelayer = null;
  var alltime_supply_availableFeturelayer = null;
  var alltime_hazard_shinsuiImagelayer = null;
  var alltime_risk_shinsuiImagelayer = null;
  var alltime_summary_notavailableGraphicsLayer = null;
  var alltime_inudation_depthFeturelayer = null;

  var classificationChart = null;
  var timeSeriesChart = null;
  var inundationDepthChart = null;
  
  var summary_suspended_ids = [];
  var alltime_summary_suspended_ids = [];

  let highlightSelect;
  
  var img_url_continue = "continue_arrow.png";
  var img_url_up = "up_arrow.png";
  var img_url_down = "down_arrow.png";
  
  var config = null;

  //configの読み込み
  var json_url = "shinsui_storylist.json";

  $.ajaxSetup({async: false});
  $.getJSON(json_url, function(json) {
    config = json;
  });
  $.ajaxSetup({async: true});
  
  var story_id = "1";
  
  $('#select_storyId > option').remove();
  for (var i=0;i<config.length;i++) {
    var id = config[i].story_id;
    var label = config[i].story_label;
    $('#select_storyId').append($('<option>').html(label).val(id));
  }

  const timeslider_map = new WebMap({
    portalItem: {
      id: "e01b23122e3944aca17e11a1f0cf241d"
    }
  });
  
  summary_notavailableGraphicsLayer = new GraphicsLayer();
  timeslider_map.add(summary_notavailableGraphicsLayer);
  summary_notavailableGraphicsLayer.visible = false;

  const timeslider_view = new MapView({
    container: "timeslider_mapviewDiv",
    map: timeslider_map,
    popup: {
      dockEnabled: true,
      dockOptions: {
        buttonEnabled: false,
        breakpoint: false,
        position: "top-left"
      }
    }
  });

  timeslider_view.ui.add("timeslider_FloodDiv", "top-right");
  timeslider_view.ui.add("timeslider_TypeDiv", "top-right");

  const alltime_map = new WebMap({
    portalItem: {
      id: "d4721a61b7b84cca8931c01c200ee340"
    }
  });
  
  alltime_summary_notavailableGraphicsLayer = new GraphicsLayer();
  alltime_map.add(alltime_summary_notavailableGraphicsLayer);

  const alltime_view = new MapView({
    container: "alltime_mapviewDiv",
    map: alltime_map, 
    popup: {
      dockEnabled: true,
      dockOptions: {
        buttonEnabled: false,
        breakpoint: false,
        position: "top-left"
      }
    }
  });

  alltime_view.ui.add("alltime_FloodDiv", "top-right");

  var lgExpand = new Expand({
    view: timeslider_view,
    expanded: false,
    mode : "floating"
  });
  timeslider_view.ui.add(lgExpand, "bottom-right");

  var legend = new Legend({
    view: timeslider_view,
    respectLayerVisibility: true
  });

  lgExpand.content = legend;


  var timeSlider = new TimeSlider({
    container: "timeSliderDiv",
    view: timeslider_view,
    fullTimeExtent: {
      start: new Date(2021, 3, 1, 9, 0),
      end: new Date(2021, 11, 31, 9, 0)
    },
    playRate: 2000,
    mode: "instant",
    stops: {
      interval: {
        value: 1,
        unit: "days"
      }
    }
  });

  timeSlider.watch("values", function(values){

    if (timeslider_risk_shinsuiImagelayer == null || timeslider_hazard_shinsuiImagelayer == null ||
        supply_availableFeturelayer == null) {
      return;
    }
    
    refreshTimesliderDiv(values[0]);
    timeslider_view.popup.close();
  });

  timeslider_map.when(function (layers) {
    supplyFeturelayer = layers.layers.find(
      value => value.title == "サプライチェーン");
    supply_availableFeturelayer = layers.layers.find(
      value => value.title == "Supply Chain Available");
    timeslider_obeservatory_Feturelayer = layers.layers.find(
      value => value.title == "OBESERVATORY");
    obeservatoryInudationDepthTable = layers.tables.find(
      value => value.title == "INUDATION_DEPTH_TBL");
    timeslider_hazard_shinsuiImagelayer = layers.layers.find(
      value => value.title == "Flood(Hazard)");
    timeslider_risk_shinsuiImagelayer = layers.layers.find(
      value => value.title == "Flood(Risk)");

    timeslider_map.reorder(timeslider_hazard_shinsuiImagelayer, 0);
    timeslider_map.reorder(timeslider_risk_shinsuiImagelayer, 1);

    refreshTimesliderDiv(new Date(2021, 3, 1));
  });

  alltime_map.when(function (layers) {
    //レイヤー取得
    alltime_obeservatoryFeturelayer = layers.layers.find(
      value => value.title == "OBESERVATORY");
    alltime_supplyFeturelayer = layers.layers.find(
      value => value.title == "サプライチェーン");
    alltime_supply_availableFeturelayer = layers.layers.find(
      value => value.title == "Supply Chain Available");
    alltime_hazard_shinsuiImagelayer = layers.layers.find(
      value => value.title == "Flood(Hazard)");
    alltime_risk_shinsuiImagelayer = layers.layers.find(
      value => value.title == "Flood(Risk)");
    alltime_inudation_depthFeturelayer = layers.tables.find(
      value => value.title == "INUDATION_DEPTH_TBL");

    alltime_map.reorder(alltime_hazard_shinsuiImagelayer, 0);
    alltime_map.reorder(alltime_risk_shinsuiImagelayer, 1);
    
    getalltimeSuspend_Graphic();
    drawTimeSeriesChart();
    drawInudationDepthChart();
  });

  timeslider_view.when(function() {

    //Suspend Suppy Chainリスト選択
    timeslider_view.whenLayerView(supply_availableFeturelayer).then(function(layerView) {
      $('body').on('click', '#inundation-depth-list li', function(e){
        observatory_feature_highlight(e);
      });
      
      $('body').on('click', '#supply-chain-list li', function(e){

        for (let li of $('li')) {
          li.classList.remove("li_selected");
        }
        e.preventDefault();
        e.target.classList.add("li_selected");
        supplychain_feature_highlight(e);
      });
      
      function observatory_feature_highlight(event) {
        let id = event.target.id;
        
        if (event.target.tagName != "LI") {
          id = event.target.parentElement.id;
        }
        
        if (id == "") return;

        var query = timeslider_obeservatory_Feturelayer.createQuery();
        query.where = "BASE_ID=" + id;

        timeslider_obeservatory_Feturelayer.queryFeatures(query).then(function(result) {

          var feature = result.features[0];

          timeslider_view.goTo(
            {
              target: feature.geometry
            },
            {
              duration: 1000,
              easing: "in-out-expo"
            }
          ).catch(function(error){
            if (error.name != "AbortError"){
              console.log(error);
            }
          });
        });
      }

      function supplychain_feature_highlight(event) {

        let value = event.target.id.split(',');


        var query = supply_availableFeturelayer.createQuery();
        query.where = "STORY_ID = " + story_id + " AND BASE_ID=" + value[0] + " AND OPERATINGDAY ='" + value[1] + "'";
        supply_availableFeturelayer.queryFeatures(query).then(function(result) {
          if (highlightSelect) {
            highlightSelect.remove();
          }

          var feature = result.features[0];

          feature.popupTemplate = supply_availableFeturelayer.popupTemplate;
          layerView.view.popup.open({
            features: [feature],
            featureMenuOpen: true,
            updateLocationEnabled: true
          });

          timeslider_view.goTo(
            {
              target: feature.geometry
            },
            {
              duration: 1000,
              easing: "in-out-expo"
            }
          ).catch(function(error){
            if (error.name != "AbortError"){
              console.log(error);
            }
          });
        });
      }
    });
  });
  
  function refreshTimesliderDiv(date) {
    $('#timeSliderValue').text((date.getMonth()+1) + "/" + date.getDate());
    shinsuiFeaturelayer_query(date);
    shinsuiImagelayer_query(date);
    drawClassificationChart(date);
    suspendlist_query(date);
    getSuspend_Graphic(date);
    obeservatory_inundation_query(date);
  }

  //storyIDの変更時
  $('#select_storyId').on('change', function(e){
    story_id = e.target.selectedOptions[0].value;
    
    //イメージサービスのURL変更
    timeslider_hazard_shinsuiImagelayer.url = config.find(value => value.story_id == Number(story_id)).shinsuiImage_url;
    timeslider_risk_shinsuiImagelayer.url = config.find(value => value.story_id == Number(story_id)).shinsuiImage_url;
    
    var id = config.find(value => value.story_id == Number(story_id)).alltime_shinsui_hazard_id;
    
    var visible = alltime_hazard_shinsuiImagelayer.visible;
    alltime_map.layers.remove(alltime_hazard_shinsuiImagelayer);
    alltime_hazard_shinsuiImagelayer = new TileLayer({
      portalItem: {
        id: id
      }
    });
    alltime_map.layers.add(alltime_hazard_shinsuiImagelayer, 0);
    alltime_hazard_shinsuiImagelayer.visible = visible;
    
    id = config.find(value => value.story_id == Number(story_id)).alltime_shinsui_risk_id;
    visible = alltime_risk_shinsuiImagelayer.visible;
    alltime_map.layers.remove(alltime_risk_shinsuiImagelayer);
    alltime_risk_shinsuiImagelayer = new TileLayer({
      portalItem: {
        id: id
      }
    });
    alltime_map.layers.add(alltime_risk_shinsuiImagelayer, 0);
    alltime_risk_shinsuiImagelayer.visible = visible;

    refreshTimesliderDiv(timeSlider.values[0]);
    timeslider_view.popup.close();
    
    getalltimeSuspend_Graphic();
    drawTimeSeriesChart();
    drawInudationDepthChart();
  });


  $('#change_body').click(function(e){

    if (e.target.textContent == "All Time") {
      $('#change_body').text("Time Slider");
    } else {
      $('#change_body').text("All Time");
    }
    $('#body1Div').toggleClass("body-active");
    $('#body1Div').toggleClass("body-nonactive");
    $('#body2Div').toggleClass("body-active");
    $('#body2Div').toggleClass("body-nonactive");
  });

  $(".switchImage").click(function(e){
    if (e.target.textContent == "Flood(Hazard)") {
      $('.imagelayertype').text("Flood(Risk)");
      timeslider_hazard_shinsuiImagelayer.visible = true;
      timeslider_risk_shinsuiImagelayer.visible = false;

      alltime_hazard_shinsuiImagelayer.visible = true;
      alltime_risk_shinsuiImagelayer.visible = false;
    } else if (e.target.textContent == "Flood(Risk)") {
      $('.imagelayertype').text("Flood(None)");
      timeslider_hazard_shinsuiImagelayer.visible = false;
      timeslider_risk_shinsuiImagelayer.visible = true;

      alltime_hazard_shinsuiImagelayer.visible = false;
      alltime_risk_shinsuiImagelayer.visible = true;
    } else {
      $('.imagelayertype').text("Flood(Hazard)");
      timeslider_hazard_shinsuiImagelayer.visible = false;
      timeslider_risk_shinsuiImagelayer.visible = false;

      alltime_hazard_shinsuiImagelayer.visible = false;
      alltime_risk_shinsuiImagelayer.visible = false;
    }
  });

  $(".switchType").click(function(e){

    if (e.target.textContent == "Summary") {
      $('.changetype').text("Suspend");
      summary_notavailableGraphicsLayer.visible = true;
      supply_availableFeturelayer.visible = false;
    } else {
      $('.changetype').text("Summary");
      summary_notavailableGraphicsLayer.visible = false;
      supply_availableFeturelayer.visible = true;
    }
  });
  
  //Display Rateのチェック
  $('#check_rate').on('change', function(){
    drawClassificationChart(timeSlider.values[0]);
  });
  
  //チャートの切り替え
  $('body').on('click', '.tab' , function() {
    $('.is-active').removeClass('is-active');
    $(this).addClass('is-active');
    $('.is-show').removeClass('is-show');
    const index = $(this).index();
    $('.panel').eq(index).addClass('is-show');
  });

  function shinsuiFeaturelayer_query(date){

    var str_date = date.getFullYear() + "/" + (date.getMonth()+1) + "/" + date.getDate();

    supply_availableFeturelayer.definitionExpression = "STORY_ID = " + story_id + "AND OPERATINGDAY = '" + str_date + "'";
  }

  function shinsuiImagelayer_query(date){

    var mr = new MosaicRule({
      where: "NAME='" + formatDate(date, 'yyyyMMdd') + "'"
    }); 
    timeslider_risk_shinsuiImagelayer.mosaicRule = mr;
    timeslider_hazard_shinsuiImagelayer.mosaicRule = mr;

  }

  function drawClassificationChart(date) {

    var str_date = date.getFullYear() + "/" + (date.getMonth()+1) + "/" + date.getDate();

    var query = supply_availableFeturelayer.createQuery();

    //稼働のみ
    query.where = "STORY_ID = " + story_id + " AND OPERATINGDAY = '" + str_date + "'";
    query.outFields = [
      "BASE_TYPE,AVAILABLE"
    ];

    query.groupByFieldsForStatistics = "BASE_TYPE,AVAILABLE";
    query.orderByFields = "BASE_TYPE,AVAILABLE";

    query.outStatistics = [
      {
        statisticType: "count",
        onStatisticField: "ObjectId",
        outStatisticFieldName: "カウント"
      }
    ]

    supply_availableFeturelayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;

      var available_list = {};
      var notavailable_list = {};
      var labels = [];
      var available_count = [];
      var notavailable_count = [];

      var display_rate = false;
      if ($('#check_rate:checked').val() != null) {
        display_rate = true;
      }

      //初期化
      for(var i = 0; i< features.length; i++) {
        var base_type = features[i].attributes["BASE_TYPE"];
        if (labels.indexOf(base_type) == -1) {
          labels.push(base_type);
          available_list[base_type] = 0;
          notavailable_list[base_type] = 0;
        }
      }

      //件数の取得
      for(var i = 0; i< features.length; i++) {
        var base_type = features[i].attributes["BASE_TYPE"];
        var available = features[i].attributes["AVAILABLE"];
        var count = features[i].attributes["カウント"];

        if (available == 0) {
          available_list[base_type] = count;
        } else {
          notavailable_list[base_type] = count;
        }
      }

      available_count = Object.values(available_list);
      notavailable_count = Object.values(notavailable_list);

      //Rateの計算
      if (display_rate == true) {
        for (var i = 0; i< available_count.length; i++) {
          var sum = available_count[i] + notavailable_count[i];
          available_count[i] = Math.floor(100 * available_count[i] / sum);
          notavailable_count[i] = Math.ceil(100 * notavailable_count[i] / sum);
        }
      }

      update_classificationChart(labels, available_count, notavailable_count);

    });

  }

  function update_classificationChart(labels, available_count, notavailable_count){

    var ctx = document.getElementById("classificationChartCanvas").getContext('2d');

    if (classificationChart != null) {
      classificationChart.destroy();
    }

    var display_rate = false;
    if ($('#check_rate:checked').val() != null) {
      display_rate = true;
    }

    var xlabel = "Place";
    var xUnit = "";
    var xStepSize = 10;

    if (display_rate == true) {
      xlabel = "Rate";
      xUnit = "%";
      xStepSize = 50;
    }

    var datasets = [];

    datasets.push({
      data: available_count,
      backgroundColor: "rgba(100,255,150,0.5)"
    });

    datasets.push({
      data: notavailable_count,
      backgroundColor: "rgba(255,0,0,0.5)"
    });

    var yLabel = "";

    classificationChart = new Chart(ctx, {
      type: 'horizontalBar',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        title: {
          display: false
        },
        layout: {
          padding: {
            left: 0,
            right: 20,
            top: 20,
            bottom: 20
          }
        },
        legend: {
          display: false
        },
        tooltips: {
          enabled: false
        },
        hover: {
          animationDuration: 0
        },
        animation: {
          duration: 1,
          onComplete: function () {
            var chartInstance = this.chart;
            var ctx = chartInstance.ctx;
            ctx.textAlign = "left";
            ctx.font = "12px Open Sans";
            ctx.fillStyle = "#fff";

            Chart.helpers.each(this.data.datasets.forEach(function (dataset, i) {
              var meta = chartInstance.controller.getDatasetMeta(i);
              Chart.helpers.each(meta.data.forEach(function (bar, index) {


                if(i==0){
                  data = " " + dataset.data[index] + xUnit + " Available";
                  ctx.fillText(data, bar._model.base, bar._model.y+4);
                } else {
                  data = " " + dataset.data[index] + xUnit + " Suspended ";
                  ctx.fillText(data, bar._model.base, bar._model.y+4);
                }
              }),this)
            }),this);
          }
        },
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: xlabel,
              fontSize: 12
            },
            ticks: {
              beginAtZero: true,
              stepSize: xStepSize,
              callback: function(value, index, values){
                return  value
              }
            },
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: "type",
              fontSize: 12
            },
            ticks: {
              beginAtZero: true,
              userCallback: function(label, index, labels) {
                if (label == null) {
                  return "No Type"
                } else {
                  return label
                }
              }
            } 
          }]
        },
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  
  //Supply Chain Time Transition
  async function drawTimeSeriesChart() {
    
    //グラフのクリア
    var chartTab = $('#timeSeriesChartTab');
    var cahrtDiv = $('#timeSeriesChartDiv');
    chartTab.empty();
    cahrtDiv.empty();

    var query = alltime_supply_availableFeturelayer.createQuery();

    query.where = "STORY_ID = " + story_id ;
    query.outFields = [
      "BASE_TYPE"
    ];

    query.groupByFieldsForStatistics = "BASE_TYPE";
    query.orderByFields = "BASE_TYPE";

    query.outStatistics = [
      {
        statisticType: "count",
        onStatisticField: "ObjectId",
        outStatisticFieldName: "カウント"
      }
    ]

    //Base_type=ALL
    await drawTimeSeriesChart_PerType();
    
    alltime_supply_availableFeturelayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;
      
      for(var i = 0; i< features.length; i++) {
        var base_type = features[i].attributes["BASE_TYPE"];
        drawTimeSeriesChart_PerType(base_type);
      }
    });

  }

  
  //Supply Chain Time Transition
  async function drawTimeSeriesChart_PerType(base_type) {

    var query = alltime_supply_availableFeturelayer.createQuery();
    
    //Base_type=ALL
    if (base_type == null) {
      query.where = "STORY_ID = " + story_id;
      query.outFields = [
        "OPERATINGDAY,AVAILABLE"
      ];
      query.groupByFieldsForStatistics = "OPERATINGDAY,AVAILABLE";
    } else {
      query.where = "STORY_ID = " + story_id + " AND BASE_TYPE = '" + base_type + "'";
      query.outFields = [
        "BASE_TYPE,OPERATINGDAY,AVAILABLE"
      ];
      query.groupByFieldsForStatistics = "BASE_TYPE,OPERATINGDAY,AVAILABLE";
    }

    query.orderByFields = "OPERATINGDAY,AVAILABLE";
    query.outStatistics = [
      {
        statisticType: "count",
        onStatisticField: "ObjectId",
        outStatisticFieldName: "カウント"
      }
    ]

    await alltime_supply_availableFeturelayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;

      var available_list = {};
      var notavailable_list = {};
      var labels = [];
      var available_count = [];
      var notavailable_count = [];
      
      var title = "ALL";
      if (features[0].attributes.hasOwnProperty("BASE_TYPE")) {
        title = features[0].attributes["BASE_TYPE"];
      }

      //初期化
      for(var i = 0; i< features.length; i++) {
        var date = new Date(features[i].attributes["OPERATINGDAY"]);
        var date_txt = formatDate(date, "MM/dd");
        if (labels.indexOf(date_txt) == -1) {
          labels.push(date_txt);
          available_list[date_txt] = 0;
          notavailable_list[date_txt] = 0;
        }
      }

      //件数の取得
      for(var i = 0; i< features.length; i++) {
        var date = new Date(features[i].attributes["OPERATINGDAY"]);
        var date_txt = formatDate(date, "MM/dd");
        var available = features[i].attributes["AVAILABLE"];
        var count = features[i].attributes["カウント"];

        if (available == 0) {
          available_list[date_txt] = count;
        } else {
          notavailable_list[date_txt] = count;
        }
      }

      available_count = Object.values(available_list);
      notavailable_count = Object.values(notavailable_list);

      update_timeSeriesChart(title, labels, available_count, notavailable_count);

    });

  }

  function update_timeSeriesChart(title, labels, available_count, notavailable_count){
    
    var chartTab = $('#timeSeriesChartTab');
    var cahrtDiv = $('#timeSeriesChartDiv');
    var panel_id = 'timeSeriasePanel_' + title;

    if (title == "ALL") {
      chartTab.append('<li class="tab is-active">' + title + '</li>');
      cahrtDiv.append('<div id="' + panel_id + '" class="panel is-show"/>');
    } else {
      chartTab.append('<li class="tab">' + title + '</li>');
      cahrtDiv.append('<div id="' + panel_id + '" class="panel"/>');
    }
    
    //Canvas生成
    var canvas_id = 'timeSeriaseChart_' + title;
    element = $('<canvas id="' + canvas_id + '" />');
    $('#' + panel_id).append(element); 
    
    var ctx = $('#' + canvas_id).get(0).getContext('2d');
    //$('#' + canvas_id).height(120);
    
    //if (timeSeriesChart != null) {
    //  timeSeriesChart.destroy();
    //}

    var datasets = [];

    datasets.push({
      label: "Available Count",
      data: available_count,
      backgroundColor: "rgba(100,255,150,0.8)"
    });

    datasets.push({
      label: "Suspended Count",
      data: notavailable_count,
      backgroundColor: "rgba(255,0,0,0.8)"
    });

    var yLabel = "";

    timeSeriesChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        title: {
          display: false,
          fontSize: 11,
          fontFamily: "sans-serif",
          text: title
        },
        layout: {
          padding: {
            left: 0,
            right: 20,
            top: 20,
            bottom: 0
          }
        },
        legend: {
          display: false
        },
        tooltips: {
          enabled: true
        },
        hover: {
          animationDuration: 0
        },
        scales: {
          xAxes: [{
            display: true,
            scaleLabel: {
              display: true,
              labelString: "Time"
            },
            ticks: {
              display: true, 
              callback: function(value, index, values){
                return value
              },
              autoSkip: true,
              maxTicksLimit: 2
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: title,
              fontSize: 12
            },
            ticks: {
              beginAtZero: true,
              userCallback: function(label, index, labels) {
                return label
              },
              stepSize: 5
            },
            stacked: true
          }]
        },
        responsive: true,
        //maintainAspectRatio: false
      }
    });
  }
  
  async function drawInudationDepthChart() {

    var query = alltime_inudation_depthFeturelayer.createQuery();
    
    query.where = "STORY_ID = " + story_id;
    query.outFields = [
      "BASE_ID"
    ];
    query.groupByFieldsForStatistics = "BASE_ID";
    query.orderByFields = "BASE_ID";
    
    query.outStatistics = [
      {
        statisticType: "count",
        onStatisticField: "ObjectId",
        outStatisticFieldName: "カウント"
      }
    ]

    var response = await alltime_inudation_depthFeturelayer.queryFeatures(query);
    drawInudationDepthPerBaseIdChart(response);
  }

  async function drawInudationDepthPerBaseIdChart(response) {
    var features = response.features;
    
    var inudation_dataset = [];
    for (var i=0;i<features.length;i++) {
      var base_id = features[i].attributes["BASE_ID"];

      var query = alltime_inudation_depthFeturelayer.createQuery();
      query.where = "STORY_ID = " + story_id + " AND BASE_ID = " + base_id;
      query.outFields = [
        "BASE_ID,OPERATINGDAY,INUDATION_DEPTH"
      ];
      query.orderByFields = "OPERATINGDAY";

      var response1 = await alltime_inudation_depthFeturelayer.queryFeatures(query);
      var features1 = response1.features;

      var label_list = {};
      var inudation_list = {};
      var label_dataset = null;
      
      for (var j=0;j<features1.length;j++) {
        var base_id = features1[j].attributes["BASE_ID"];
        var date = new Date(features1[j].attributes["OPERATINGDAY"]);
        var date_txt = formatDate(date, "MM/dd");
        
        var value = features1[j].attributes["INUDATION_DEPTH"];
        var value_txt = Math.round(value*10000) / 10000;
        
        label_list[date] = date_txt;
        inudation_list[date] = value_txt;
      }

      label_dataset = Object.values(label_list);
      inudation_dataset.push({
        id: base_id,
        data: Object.values(inudation_list)
      });

    }
    update_InudationDepthChart(label_dataset, inudation_dataset)
  }


  function update_InudationDepthChart(labels, inudations){

    if (inundationDepthChart != null) {
      inundationDepthChart.destroy();
    }
    
    var ctx = document.getElementById("inundationDepthChartCanvas");
    var datasets = [];
    var colors = [
      "rgba(255,0,0,1)",
      "rgba(0,0,255,1)",
      "rgba(0,255,0,1)",
      "rgba(255,0,255,1)",
    ];

    for (var i=0;i<inudations.length;i++) {
      datasets.push({
        label: inudations[i].id,
        fill: false,
        borderWidth: 1, 
        data: inudations[i].data,
        pointRadius: 0,
        borderColor: colors[i%colors.length] 
      });  
    }
    var yLabel = "";

    inundationDepthChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        title: {
          display: false,
          fontSize: 11,
          fontFamily: "sans-serif",
          text: "Inudation Depth"
        },
        layout: {
          padding: {
            left: 0,
            right: 20,
            top: 20,
            bottom: 0
          }
        },
        legend: {
          display: true
        },
        tooltips: {
          enabled: true,
          mode: 'index'
        },
        hover: {
          animationDuration: 0
        },
        scales: {
          xAxes: [{
            display: true,
            scaleLabel: {
              display: true,
              labelString: "Time"
            },
            ticks: {
              display: true, 
              callback: function(value, index, values){
                return value
              },
              autoSkip: true,
              maxTicksLimit: 2
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: "Inudation Depth(m)",
              fontSize: 12
            },
            ticks: {
              beginAtZero: true,
              userCallback: function(label, index, labels) {
                return label
              },
              //suggestedMax: 5.00,
              suggestedMin: 0.00,
              stepSize: 0.5
            },
            stacked: false
          }]
        },
        responsive: true,
        //maintainAspectRatio: false
      }
    });
  }
  
  //観測所ごとの浸水深表示
  async function obeservatory_inundation_query(date) {

    var str_date = date.getFullYear() + "/" + (date.getMonth()+1) + "/" + date.getDate();
    var before_date = new Date(date.getTime());
    before_date.setDate(before_date.getDate() - 1);
    var str_before_date = before_date.getFullYear() + "/" + (before_date.getMonth()+1) + "/" + before_date.getDate();

    var query = obeservatoryInudationDepthTable.createQuery();

    query.where = "STORY_ID = " + story_id 
    query.where += " AND (OPERATINGDAY = '" + str_date + "' OR OPERATINGDAY = '" + str_before_date + "')";
    query.outFields = [
      "*"
    ];
    query.orderByFields = "BASE_ID,OPERATINGDAY";
    query.returnGeometry = false;

    var response = await obeservatoryInudationDepthTable.queryFeatures(query);
    var features = response.features;
    
    var obeservatory_list = {}
    var depth_list = {}
    var diff_depth_list = {}

    $('#inundation-depth-list').empty();
    
    //観測所ごとの浸水深を取得
    for(var i = 0; i< features.length; i++) {
      var base_id = features[i].attributes["BASE_ID"];
      var depth = features[i].attributes["INUDATION_DEPTH"];
      var round_depth = Math.round(depth*100) / 100;
      var operatingday = new Date(features[i].attributes["OPERATINGDAY"]);

      var str_operatingday = operatingday.getFullYear() + "/" + (operatingday.getMonth()+1) + "/" + operatingday.getDate();
      
      if ((base_id in depth_list) == false) {
        depth_list[base_id] = 0;
        diff_depth_list[base_id] = 0;
      }
      
      if (str_operatingday == str_date) {
        depth_list[base_id] = round_depth;
        diff_depth_list[base_id] += depth;
      } else {
        diff_depth_list[base_id] -= depth;
      }
    }
    
    query = timeslider_obeservatory_Feturelayer.createQuery();

    query.where = "1=1";
    query.outFields = [
      "*"
    ];
    query.orderByFields = "BASE_ID";
    query.returnGeometry = false;

    var response = await timeslider_obeservatory_Feturelayer.queryFeatures(query);
    var features = response.features;
    
    //観測所名を取得
    for(var i = 0; i< features.length; i++) {
      var base_id = features[i].attributes["BASE_ID"];
      var name = features[i].attributes["NAME"];
      obeservatory_list[base_id] = name;
    }
    
    //観測所ごとの浸水深を表示
    for(var base_id in obeservatory_list) {
      if(obeservatory_list.hasOwnProperty(base_id) && depth_list.hasOwnProperty(base_id) && diff_depth_list.hasOwnProperty(base_id)) {
        var name = obeservatory_list[base_id];
        var depth = depth_list[base_id];
        var diff = diff_depth_list[base_id];
        
        var list_html = '<li id="' + base_id + '" class="inundation-depth-panel">';
        
        if (diff == 0) {
          list_html += '<img src="' + img_url_continue + '" class="inundation-depth-image"/>'
        } else if (diff > 0) {
          list_html += '<img src="' + img_url_up + '" class="inundation-depth-image"/>'
        } else if (diff < 0) {
          list_html += '<img src="' + img_url_down + '" class="inundation-depth-image"/>'
        }
        
        list_html += '<span>OBESERVATORY:　' + base_id + ":" + name + '<br>INUDATION_DEPTH:　' + depth + '</span>'
        list_html += '</li>';
        
        $('#inundation-depth-list').append(list_html);
      }
    }
  }

  function suspendlist_query(date) {

    var str_date = date.getFullYear() + "/" + (date.getMonth()+1) + "/" + date.getDate();

    var query = supply_availableFeturelayer.createQuery();

    //不稼働のみ
    query.where = "STORY_ID = " + story_id + " AND OPERATINGDAY = '" + str_date + "' AND AVAILABLE = 1";
    query.outFields = [
      "*"
    ];

    supply_availableFeturelayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;

      $('#supply-chain-list').empty();

      for(var i = 0; i< features.length; i++) {
        var base_id = features[i].attributes["BASE_ID"];
        var name = features[i].attributes["NAME"];
        var base_type = features[i].attributes["BASE_TYPE"];
        var depth = features[i].attributes["INUNDATION_DEPTH"];

        depth = Math.round(depth * 100) / 100;

        var operatingday = new Date(features[i].attributes["OPERATINGDAY"]);

        var str_operatingday = operatingday.getFullYear() + "/" + (operatingday.getMonth()+1) + "/" + operatingday.getDate();

        if (base_type == null) {
          base_type = "No Type";
        }
        $('#supply-chain-list').append('<li id="' + base_id + ',' + str_operatingday + '">SuppyChain:' + base_id + ' ' + name + '<br>TYPE:' + base_type + '<br/>INUNDATION_DEPTH:' + depth + '</li>');
      }
    });
  }
  
  function getSuspend_Graphic(date) {
    
    var str_date = date.getFullYear() + "/" + (date.getMonth()+1) + "/" + date.getDate();

    var query = supply_availableFeturelayer.createQuery();
    //不稼働のみ
    query.where = "STORY_ID = " + story_id + " AND OPERATINGDAY <= '" + str_date + "' AND AVAILABLE = 1";
    query.outFields = [
      "BASE_ID"
    ];
    query.returnGeometry = false;

    query.groupByFieldsForStatistics = "BASE_ID";
    query.orderByFields = "BASE_ID";

    query.outStatistics = [
      {
        statisticType: "count",
        onStatisticField: "ObjectId",
        outStatisticFieldName: "カウント"
      }
    ]

    supply_availableFeturelayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;

      summary_suspended_ids = [];
      
      for(var i = 0; i< features.length; i++) {
        var base_id = features[i].attributes["BASE_ID"];
        var count = features[i].attributes["カウント"];
        summary_suspended_ids[base_id] = count;
      }
      summary_notavailable_addgraphic();
    });
  }
  
  function summary_notavailable_addgraphic(){

    var query = supplyFeturelayer.createQuery();
    query.where = "1=1";
    query.outFields = ["BASE_ID, NAME"];

    supplyFeturelayer.queryFeatures(query)
      .then(function(response){
      
      summary_notavailableGraphicsLayer.removeAll();
      
      var features = response.features;
      
      for(var i = 0; i< features.length; i++) {
        var base_id = features[i].attributes["BASE_ID"];
        
        var graphic = features[i];
        graphic.symbol = {
          type: "simple-marker",
          color: "green",
          size: "12px",
          style: "circle",
        };

        var suspended_ids = Object.keys(summary_suspended_ids);

        if (suspended_ids.length != 0 && suspended_ids.indexOf(base_id) == -1) {
          graphic.attributes["COUNT"] = summary_suspended_ids[base_id];

          if (summary_suspended_ids[base_id] > 90) { 
            graphic.symbol.color = "red";
          } else if (summary_suspended_ids[base_id] > 60) { 
            graphic.symbol.color = "orange";
          } else if (summary_suspended_ids[base_id] > 30) { 
            graphic.symbol.color = "yellow";
          } else { 
            graphic.symbol.color = "green";
          }             
        } else {
          graphic.attributes["COUNT"] = 0;
        }

        graphic.popupTemplate = {
          title: "{NAME}",
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "BASE_ID",
                  label: "BASE_ID"
                },
                {
                  fieldName: "NAME",
                  label: "NAME"
                },
                {
                  fieldName: "COUNT",
                  label: "Suspend Days"
                }
              ]
            }
          ]
        };
        
        summary_notavailableGraphicsLayer.add(graphic);
      }
    });
  }
  
  function getalltimeSuspend_Graphic() {

    var query = alltime_supply_availableFeturelayer.createQuery();

    //不稼働のみ
    query.where = "STORY_ID = " + story_id + " AND AVAILABLE = 1";
    query.outFields = [
      "BASE_ID"
    ];
    query.returnGeometry = false;

    query.groupByFieldsForStatistics = "BASE_ID";
    query.orderByFields = "BASE_ID";

    query.outStatistics = [
      {
        statisticType: "count",
        onStatisticField: "ObjectId",
        outStatisticFieldName: "カウント"
      }
    ]

    alltime_supply_availableFeturelayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;

      alltime_summary_suspended_ids = {};

      for(var i = 0; i< features.length; i++) {
        var base_id = features[i].attributes["BASE_ID"];
        var count = features[i].attributes["カウント"];
        alltime_summary_suspended_ids[base_id] = count;
      }
      
      alltime_summary_notavailable_addgraphic();
    });
  }
  
  function alltime_summary_notavailable_addgraphic(){

    var query = alltime_supplyFeturelayer.createQuery();
    query.where = "1=1";
    query.outFields = ["BASE_ID, NAME"];

    alltime_supplyFeturelayer.queryFeatures(query)
      .then(function(response){
      
      alltime_summary_notavailableGraphicsLayer.removeAll();
      
      var features = response.features;
      
      for(var i = 0; i< features.length; i++) {
        var base_id = features[i].attributes["BASE_ID"];
        
        var graphic = features[i];
        graphic.symbol = {
          type: "simple-marker",
          color: "green",
          size: "12px",
          style: "circle",
        };

        var suspended_ids = Object.keys(alltime_summary_suspended_ids);

        if (suspended_ids.length != 0 && suspended_ids.indexOf(base_id) == -1) {
          graphic.attributes["COUNT"] = alltime_summary_suspended_ids[base_id];

          if (alltime_summary_suspended_ids[base_id] > 90) { 
            graphic.symbol.color = "red";
          } else if (alltime_summary_suspended_ids[base_id] > 60) { 
            graphic.symbol.color = "orange";
          } else if (alltime_summary_suspended_ids[base_id] > 30) { 
            graphic.symbol.color = "yellow";
          } else { 
            graphic.symbol.color = "green";
          }             
        } else {
          graphic.attributes["COUNT"] = 0;
        }

        graphic.popupTemplate = {
          title: "{NAME}",
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "BASE_ID",
                  label: "BASE_ID"
                },
                {
                  fieldName: "NAME",
                  label: "NAME"
                },
                {
                  fieldName: "COUNT",
                  label: "Suspend Days"
                }
              ]
            }
          ]
        };
        
        alltime_summary_notavailableGraphicsLayer.add(graphic);
      }
    });
  }
});


function formatDate(date, format) {
  format = format.replace(/yyyy/g, date.getFullYear());
  format = format.replace(/MM/g, ('0' + (date.getMonth() + 1)).slice(-2));
  format = format.replace(/dd/g, ('0' + date.getDate()).slice(-2));
  format = format.replace(/HH/g, ('0' + date.getHours()).slice(-2));
  format = format.replace(/mm/g, ('0' + date.getMinutes()).slice(-2));
  format = format.replace(/ss/g, ('0' + date.getSeconds()).slice(-2));
  format = format.replace(/SSS/g, ('00' + date.getMilliseconds()).slice(-3));
  return format;
};
    </script>

  

</body>

</html>
 
