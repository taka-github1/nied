

<!DOCTYPE html>
<html lang="en" >

<head>

  <meta charset="UTF-8">
  
<link rel="apple-touch-icon" type="image/png" href="https://cpwebassets.codepen.io/assets/favicon/apple-touch-icon-5ae1a0698dcc2402e9712f7d01ed509a57814f994c660df9f7a952f3060705ee.png" />
<meta name="apple-mobile-web-app-title" content="CodePen">

<link rel="shortcut icon" type="image/x-icon" href="https://cpwebassets.codepen.io/assets/favicon/favicon-aec34940fbc1a6e787974dcd360f2c6b63348d4b1f4e06c77743096d55480f33.ico" />

<link rel="mask-icon" type="" href="https://cpwebassets.codepen.io/assets/favicon/logo-pin-8f3771b1072e3c38bd662872f6b673a722f4b3ca2421637d5596661b4e2132cc.svg" color="#111" />


  <title>CodePen - サプライチェーン解析_v01</title>
  
  
  
  
<style>
html,
body,

#mainDiv {
  height: 99%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background-color: black;
  color: white;
}

#headerDiv {
  height: 8%;
  display: flex;
  flex-direction: row;
}

#centermainDiv {
  height: 85%;
  width: 100%;
  display: flex;
  flex-direction: row;
}

#leftDiv {
  width: 30%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

#viewDiv {
  padding: 0;
  margin: 0;
  height: 100%;
  width: 40%;
  background-color: black;
}

#rightDiv {
  width: 30%;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow-y: scroll;
}

.chart-panel {
  display: flex;
  flex-wrap: wrap; 
  flex-direction: column;
  height: 100%;
  width: 100%;
  align-content: left;
  padding: 0px;
}

#timeSliderDiv {
  height: 10%;
  width: 100%;
  margin-bottom: 10px;
}

/* esri overrides */
.esri-time-slider__layout--wide .esri-time-slider__time-extent,
.esri-time-slider__layout--compact .esri-time-slider__time-extent,
.esri-time-slider__layout--wide .esri-time-slider__min,
.esri-time-slider__layout--wide .esri-time-slider__max,
.esri-time-slider__layout--compact .esri-time-slider__min-date,
.esri-time-slider__layout--compact .esri-time-slider__max-date,
.esri-legend__layer-caption {
  display: none !important;
}

.title {
  font-size: 24px;
  color: white;
  font-weight: bold;
}

.subtitle {
  font-size: 14px;
  color: red;
  font-weight: bold;
}

ul {
  margin: 0 auto;
  padding: 0;
  width: 95%;
  overflow-y: auto;
}

li {
  list-style: none;
  background-color: rgba(0, 0, 0, 0.05);
  padding: 10px 10px 10px 10px;
  border: 1px solid #CCC;
  box-shadow: inset 1px 1px 0 rgba(255, 255, 255, 0.5);
  margin-bottom: 5px;
  box-sizing: border-box;
  cursor: pointer;
  border-radius: 3px;
  font-size: 9px;
}

li:hover {
  background-color: rgba(0, 0, 120, 0.5);
}
</style>

  
  
  
  

</head>

<body translate="no" >
  <html>
  <head>
    <meta charset="utf-8" />
    <meta
          name="viewport"
          content="initial-scale=1,maximum-scale=1,user-scalable=no"
          />
    <title>
      TimeSlider
    </title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <link
          rel="stylesheet"
          href="https://js.arcgis.com/4.16/esri/themes/dark-red/main.css"
          />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://js.arcgis.com/4.16/"></script>
  </head>

  <body>
    <div id="mainDiv">
      <div id="headerDiv">
        <span class="title">Supply Chain Flood Risk Simulation</span>
      </div>
      <div id="centermainDiv">
        <div id="leftDiv">
          <span class="subtitle">Operation Supply Chain</span>
          <div id="chatDiv">
            <div class="chart-panel">
              <canvas id="chartCanvas"/>
            </div>
          </div>
          <div id="layerListDiv"></div>
        </div>
        <div id="viewDiv"></div>
        <div id="rightDiv">
          <span class="subtitle">Suspended Supply Chain</span>
          <ul id="supply-chain-list">
          </ul>
        </div>
      </div>
      <div id="timeSliderDiv"></div>
    </div>
  </body>
</html>
  
  
      <script id="rendered-js" >
require([
  "esri/WebMap", 
  "esri/layers/FeatureLayer",
  "esri/views/MapView",
  "esri/widgets/Legend",
  "esri/widgets/Expand",
  "esri/widgets/LayerList",
  "esri/widgets/TimeSlider",
  "esri/core/watchUtils",
  "esri/core/promiseUtils",
  "esri/layers/ImageryLayer",
  "esri/tasks/support/Query",
  "esri/tasks/QueryTask",
  "esri/renderers/ClassBreaksRenderer",
  "esri/layers/support/RasterFunction",
  "esri/renderers/RasterColormapRenderer",
  "esri/layers/support/MosaicRule"
], function (
        WebMap,
         FeatureLayer,
         MapView,
         Legend,
         Expand,
         LayerList,
         TimeSlider,
         watchUtils,
         promiseUtils,
         ImageryLayer,
         Query,
         QueryTask,
         ClassBreaksRenderer,
         RasterFunction,
         RasterColormapRenderer,
         MosaicRule
        ) {

  cnt = 0;

  var chart = null;
  
  let highlightSelect;

  const map = new WebMap({
    portalItem: {
      id: "8c25d7bccc3e4b5896131c16821967a1"
    }
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    popup: {
      dockEnabled: true,
      dockOptions: {
        buttonEnabled: false,
        breakpoint: false,
        position: "top-left"
      }
    }
  });
  
  var layerlist = new LayerList({
    view: view,
    //container: "layerListDiv",
    respectLayerVisibility: false
  });

  var timeSlider = new TimeSlider({
    container: "timeSliderDiv",
    view: view,
    fullTimeExtent: {
      start: new Date(2021, 3, 1, 9, 0),
      end: new Date(2021, 11, 31, 9, 0)
    },
    playRate: 2000,
    mode: "instant",
    stops: {
      interval: {
        value: 1,
        unit: "days"
      }
    }
  });

  timeSlider.watch("values", function(values){
    var str_date = values[0].getFullYear() + "/" + (values[0].getMonth()+1) + "/" + values[0].getDate();

    shinsuiFeaturelayer_query(values[0]);
    shinsuiImagelayer_query(values[0]);
    drawChart(values[0]);
    suspendlist_query(values[0]);

  });

  var supplyFeturelayer = null;
  var shinsuiFeaturelayer 
  = null;
  var shinsuiImagelayer = null;

  map.when(function (layers) {
    supplyFeturelayer = layers.findLayerById("1779fc2549c-layer-5");

    shinsuiFeaturelayer = layers.findLayerById("1779e591c0c-layer-33");
    shinsuiImagelayer = layers.findLayerById("satreps_thai_shinsui_7796");
    
    shinsuiFeaturelayer_query(new Date(2021, 3, 1));
    shinsuiImagelayer_query(new Date(2021, 3, 1));
    drawChart(new Date(2021, 3, 1));
    suspendlist_query(new Date(2021, 3, 1));
  });

  view.when(function() {

    view.whenLayerView(supplyFeturelayer).then(function(layerView) {
      $('body').on('click', '#supply-chain-list li', function(e){
        e.preventDefault();
        feature_highlight(e)
      });
      
      function feature_highlight(event) {

        
        let value = event.target.id.split(',');
        
        
        var query = supplyFeturelayer.createQuery();
        query.where = "BASE_ID=" + value[0] + " AND OPERATINGDAY ='" + value[1] + "'";
        supplyFeturelayer.queryFeatures(query).then(function(result) {
          if (highlightSelect) {
            highlightSelect.remove();
          }

          var feature = result.features[0];

          feature.popupTemplate = supplyFeturelayer.popupTemplate;
          layerView.view.popup.open({
            features: [feature],
            featureMenuOpen: true,
            updateLocationEnabled: true
          });
          
          view.goTo(
            {
              target: feature.geometry
            },
            {
              duration: 1000,
              easing: "in-out-expo"
            }
          ).catch(function(error){
            if (error.name != "AbortError"){
              console.log(error);
            }
          });
        });
      }
    });
  });



  function shinsuiFeaturelayer_query(date){

    var str_date = date.getFullYear() + "/" + (date.getMonth()+1) + "/" + date.getDate();

    supplyFeturelayer.definitionExpression = "OPERATINGDAY = '" + str_date + "'";

    shinsuiFeaturelayer.definitionExpression = "OPERATINGDAY = '" + str_date + "'";

  }

  function shinsuiImagelayer_query(date){

    var mr = new MosaicRule({
      where: "NAME='" + formatDate(date, 'yyyyMMdd') + "'"
    }); 
    shinsuiImagelayer.mosaicRule = mr;

  }
  
  function drawChart(date) {

    var str_date = date.getFullYear() + "/" + (date.getMonth()+1) + "/" + date.getDate();

    var query = supplyFeturelayer.createQuery();

    //稼働のみ
    query.where = "OPERATINGDAY = '" + str_date + "' AND AVAILABLE = 0";
    query.outFields = [
      "BASE_TYPE"
    ];

    query.groupByFieldsForStatistics = "BASE_TYPE";

    query.outStatistics = [
      {
        statisticType: "count",
        onStatisticField: "ObjectId",
        outStatisticFieldName: "カウント"
      }
    ]

    supplyFeturelayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;

      var labels = [];
      var available_count = [];

      for(var i = 0; i< features.length; i++) {
        var base_type = features[i].attributes["BASE_TYPE"];
        var count = features[i].attributes["カウント"];

        labels.push(base_type);
        available_count.push(count);
      }

      update_chart(labels, available_count);

    });

  }

  function update_chart(labels, datas){

    var ctx = document.getElementById("chartCanvas").getContext('2d');

    if (chart != null) {
      chart.destroy();
    }

    var datasets = [];

    datasets.push({
      data: datas,
      borderColor: "rgba(0,169,255,1)",
      backgroundColor: "rgba(0,169,255,1)",
      datalabels: {
        display: true
      }
    });

    var yLabel = "";

    chart = new Chart(ctx, {
      type: 'horizontalBar',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        title: {
          display: false
        },
        layout: {
          padding: {
            left: 0,
            right: 0,
            top: 0
          }
        },
        legend: {
          display: false
        },
        animation: false,
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Available Count',
              fontSize: 12
            },
            ticks: {
              beginAtZero: true,
              stepSize: 10,
              suggestedMax: 100,
              callback: function(value, index, values){
                return  value
              }
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: yLabel,
              fontSize: 12
            },
            barPercentage: 0.8,
            ticks: {
              beginAtZero: true,
              userCallback: function(label, index, labels) {
                if (label == null) {
                  return "No Type"
                } else {
                  return label
                }

              }
            }
          }]
        },
        responsive: true,
        maintainAspectRatio: false

      },
      plugins: {
        datalabels: {
          display: true,
          align: "end",
          anchor: "end",
          color: "black",
          formatter: function(value, context) {
            return context.chart.data.labelsData[context.dataIndex];
          },
        }
      }
    });
  }

  function suspendlist_query(date) {

    var str_date = date.getFullYear() + "/" + (date.getMonth()+1) + "/" + date.getDate();

    var query = supplyFeturelayer.createQuery();

    //不稼働のみ
    query.where = "OPERATINGDAY = '" + str_date + "' AND AVAILABLE = 1";
    query.outFields = [
      "*"
    ];

    supplyFeturelayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;
      
      $('#supply-chain-list').empty();

      for(var i = 0; i< features.length; i++) {
        var base_id = features[i].attributes["BASE_ID"];
        var name = features[i].attributes["NAME"];
        var base_type = features[i].attributes["BASE_TYPE"];
        var depth = features[i].attributes["INUNDATION_DEPTH"];
        var operatingday = new Date(features[i].attributes["OPERATINGDAY"]);
        
        var str_operatingday = operatingday.getFullYear() + "/" + (operatingday.getMonth()+1) + "/" + operatingday.getDate();

        if (base_type == null) {
          base_type = "No Type";
        }
        $('#supply-chain-list').append('<li id="' + base_id + ',' + str_operatingday + '">SuppyChain:' + base_id + ' ' + name + '<br>TYPE:' + base_type + '<br/>INUNDATION_DEPTH:' + depth + '</li>');
      }
    });
  }
  
});


function formatDate (date, format) {
  format = format.replace(/yyyy/g, date.getFullYear());
  format = format.replace(/MM/g, ('0' + (date.getMonth() + 1)).slice(-2));
  format = format.replace(/dd/g, ('0' + date.getDate()).slice(-2));
  format = format.replace(/HH/g, ('0' + date.getHours()).slice(-2));
  format = format.replace(/mm/g, ('0' + date.getMinutes()).slice(-2));
  format = format.replace(/ss/g, ('0' + date.getSeconds()).slice(-2));
  format = format.replace(/SSS/g, ('00' + date.getMilliseconds()).slice(-3));
  return format;
};
    </script>

  

</body>

</html>
 
